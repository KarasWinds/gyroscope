import pandas as pd
import stdev_with_tag as std
from sklearn.externals import joblib


def vote(ls):
    # list: index = 狀態
    num = [0, 0, 0, 0]
    for i in ls:
        num[i] += 1
    # 找出list當中最大的 index
    max_index = 0
    max_value = 0
    for i in range(len(num)):
        if num[i] > max_value:
            max_index = i
    return max_index


if __name__ == '__main__':
    # 因為是範例, 所以把msg_input寫成死的字串
    # 真實情況 --> 用consumer收到的資料每五十筆作一次評估
    msg_input = '''
    2019-01-10 20:54:22.35,2,-395,261,79,-3.01526717557,1.99236641221,0.603053435115,-308,-508,16236,-0.018798828125,-0.031005859375,0.990966796875,-1.79179187267,1.08625000749\n\
    2019-01-10 20:54:22.46,3,-375,259,85,-2.86259541985,1.97709923664,0.648854961832,-356,-420,16308,-0.021728515625,-0.025634765625,0.995361328125,-1.47493139206,1.25014106049\n\
    2019-01-10 21:41:40.83,26428,-2720,793,5789,-20.7633587786,6.0534351145,44.1908396947,464,5268,2884,0.0283203125,0.321533203125,0.176025390625,60.9917857543,-4.41784025507\n\
    2019-01-10 21:41:40.94,26429,1291,-3315,-2832,9.85496183206,-25.3053435115,-21.6183206107,-14684,-14300,21416,-0.896240234375,-0.872802734375,1.30712890625,-28.8418936937,29.6927064244\n\
    2019-01-10 21:41:41.05,26430,4162,5158,-9511,31.7709923664,39.3740458015,-72.6030534351,768,-2116,23844,0.046875,-0.129150390625,1.45532226562,-5.06872798093,-1.83760587019\n\
    2019-01-10 21:41:41.16,26431,4749,5069,-7728,36.2519083969,38.6946564885,-58.9923664122,-1496,-4136,10208,-0.09130859375,-0.25244140625,0.623046875,-21.8453676547,7.73493616267\n\
    2019-01-10 21:41:41.27,26432,1237,589,1331,9.4427480916,4.49618320611,10.1603053435,-5536,-5404,-2464,-0.337890625,-0.329833984375,-0.150390625,-41.7268982196,42.9874782951\n\
    2019-01-10 21:41:41.37,26433,-3857,-2926,1948,-29.4427480916,-22.3358778626,14.8702290076,-6712,-6488,32767,-0.40966796875,-0.39599609375,1.99993896484,-10.9776946723,11.3616619066\n\
    2019-01-10 21:41:41.48,26434,-6308,-2864,11939,-48.1526717557,-21.8625954198,91.1374045802,1628,-3528,17272,0.099365234375,-0.21533203125,1.05419921875,-11.4949148008,-5.27628523766\n\
    2019-01-10 21:41:41.27,26432,1237,589,1331,9.4427480916,4.49618320611,10.1603053435,-5536,-5404,-2464,-0.337890625,-0.329833984375,-0.150390625,-41.7268982196,42.9874782951\n\
    2019-01-10 21:41:41.37,26433,-3857,-2926,1948,-29.4427480916,-22.3358778626,14.8702290076,-6712,-6488,32767,-0.40966796875,-0.39599609375,1.99993896484,-10.9776946723,11.3616619066\n\
    2019-01-10 21:41:41.48,26434,-6308,-2864,11939,-48.1526717557,-21.8625954198,91.1374045802,1628,-3528,17272,0.099365234375,-0.21533203125,1.05419921875,-11.4949148008,-5.27628523766\n\
    '''

    col = ['time', 'data_no.', 'gyro_x', 'gyro_y', 'gyro_z', 'g_x_scaled',
           'g_y_scaled', 'g_z_scaled', 'accel_x', 'accel_y', 'accel_z', 'a_x_scaled', 'a_y_scaled', 'a_z_scaled', 'rotation_x', 'rotation_y']

    df = pd.DataFrame(columns=col)

    for item in msg_input.split('\n'):
        item = item.split(',')
        if len(item) == 16:
            ser = pd.Series({col[i]: item[i] for i in range(16)})
            df = df.append(ser, ignore_index=True)

    # 欄位轉成float
    for col in list(df)[2:]:
        df[col] = df[col].astype(float)

    # 算標準差
    ls = ['gyro_x', 'gyro_y', 'gyro_z', 'accel_x', 'accel_y', 'accel_z',
          'rotation_x', 'rotation_y']
    df_trans = std.transfer(df, ls)
    df_model = df_trans.drop(['time', 'data_no.'], axis=1)

    # 評分
    clf = joblib.load('clf.pkl')
    lis = list(clf.predict(df_model))
    print(lis)
    print('狀態', vote(lis))

    # 把評分/使用者代號加入df
    usercode = '00'
    dic1 = {'userID': [usercode for i in range(len(list(df_trans['time'])))],
            'tag': [str(vote(lis)) for i in range(len(list(df_trans['time'])))]}
    df_add = pd.DataFrame.from_dict(dic1)
    df_trans.index = range(len(df_trans.index))
    df_trans = pd.concat([df_add, df_trans], axis=1)
    print(df_trans)

    # 將結果的df(每五十筆一次)存成csv或存進SQL...